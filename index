<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ソフトボール配球記録アプリ</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f0fdf4; }
        
        /* Grid System for Strike Zone */
        .zone-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; background: #333; padding: 2px; width: 200px; height: 200px; }
        .zone-cell { background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; transition: all 0.1s; }
        .zone-cell:hover { opacity: 0.8; }
        .zone-cell.strike-zone { background: #fee2e2; border: 1px solid #f87171; }
        .zone-cell.selected { background: #ef4444 !important; color: white; font-weight: bold; }
        
        .btn-action { @apply px-2 py-3 rounded shadow font-bold text-white transition-colors text-sm flex items-center justify-center; }
        .btn-count { @apply px-3 py-4 rounded shadow font-bold text-white transition-colors text-sm flex flex-col items-center justify-center w-20; }
        
        /* Position Button Styling */
        .pos-btn { @apply px-1 py-2 text-xs border rounded bg-white text-gray-700 font-bold text-center transition-colors; }
        .pos-btn.selected { @apply bg-indigo-600 text-white border-indigo-600 shadow-inner; }
        
        /* Runner Diamond Styles */
        .runner-base { cursor: pointer; transition: all 0.2s; }
        .runner-base:hover { opacity: 0.8; }
        .runner-base.active { fill: #ef4444; stroke: #b91c1c; }
        .runner-base.empty { fill: #e5e7eb; stroke: #9ca3af; pointer-events: none; }
        .runner-base.selected { stroke: #2563eb; stroke-width: 4px; }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icons ---
        const IconActivity = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>;
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>;
        const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>;
        const IconUndo = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg>;
        const IconRun = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 2h2"/><path d="M5 10h2"/><path d="M5 18h2"/><path d="M10 21l3-6 4-3-3-4-1-6"/><path d="M14 15l4 4"/></svg>;
        const IconList = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;
        const IconUserPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>;
        const IconUsers = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
        const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const IconPieChart = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;

        // --- Constants & Generators ---
        const createInitialRoster = () => Array(9).fill(null).map((_, i) => ({ id: crypto.randomUUID(), name: `選手 ${i + 1}`, number: `${i + 1}`, pos: '打', throw: '右', bat: '右' }));
        const PITCH_TYPES = ['ストレート', 'ライズ', 'ドロップ', 'チェンジ', 'カーブ', 'スライダー', 'シュート'];
        
        // Fixed Color Mapping for Pitch Types
        const PITCH_COLOR_MAP = {
            'ストレート': '#3b82f6', // Blue
            'ライズ': '#ef4444',     // Red
            'ドロップ': '#10b981',   // Green
            'チェンジ': '#f59e0b',   // Yellow
            'カーブ': '#8b5cf6',     // Purple
            'スライダー': '#ec4899', // Pink
            'シュート': '#6366f1'    // Indigo
        };
        const DEFAULT_PITCH_COLOR = '#9ca3af'; 

        const POSITIONS = ['投', '捕', '一', '二', '三', '遊', '左', '中', '右'];
        const RESULTS = [
            { label: 'ボール', type: 'ball' }, { label: '見逃しS', type: 'strike_look' }, { label: '空振りS', type: 'strike_swing' }, { label: 'ファウル', type: 'foul' },
            { label: '単打', type: 'hit1' }, { label: '二塁打', type: 'hit2' }, { label: '三塁打', type: 'hit3' }, { label: '本塁打', type: 'hr' },
            { label: 'ゴロアウト', type: 'out_goro' }, { label: 'フライアウト', type: 'out_fly' }, { label: '三振', type: 'out_so' }, 
            { label: '四球', type: 'walk' }, { label: '死球', type: 'hbp' }, { label: 'エラー', type: 'error' },
        ];
        const STRIKE_INDICES = [6, 7, 8, 11, 12, 13, 16, 17, 18];
        const ZONE_LABELS = [
            "高外ボール", "高ボール", "高ボール", "高ボール", "高内ボール", "外ボール", "外高", "真ん中高", "内高", "内ボール", "外ボール", "外中", "真ん中", "内中", "内ボール", "外ボール", "外低", "真ん中低", "内低", "内ボール", "低外ボール", "低ボール", "低ボール", "低ボール", "低内ボール"
        ];

        // --- Components ---
        
        const PieChart = ({ data }) => {
            if (!data || data.length === 0) return <div className="w-32 h-32 bg-gray-200 rounded-full flex items-center justify-center text-xs text-gray-500">No Data</div>;
            
            let currentAngle = 0;
            const gradientParts = data.map(d => {
                const start = currentAngle;
                const end = currentAngle + d.percentage;
                currentAngle = end;
                return `${d.color} ${start}% ${end}%`;
            });
            const backgroundStyle = `conic-gradient(${gradientParts.join(', ')})`;

            return (
                <div className="flex items-center space-x-4">
                    <div className="w-32 h-32 rounded-full border shadow-inner flex-shrink-0" style={{ background: backgroundStyle }}></div>
                    <div className="text-xs space-y-1">
                        {data.map((d, i) => (
                            <div key={i} className="flex items-center">
                                <span className="w-3 h-3 inline-block rounded-sm mr-2" style={{ backgroundColor: d.color }}></span>
                                <span className="font-bold mr-1">{d.label}</span>
                                <span>{d.count}球 ({Math.round(d.percentage)}%)</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const StatsView = ({ history, onBack }) => {
            const pitchers = useMemo(() => {
                return [...new Set(history.map(h => h.pitcher).filter(p => p))];
            }, [history]);

            const [selectedPitcher, setSelectedPitcher] = useState('all');

            const stats = useMemo(() => {
                let pitches = history.filter(h => h.result !== '状況変化');
                if (selectedPitcher !== 'all') {
                    pitches = pitches.filter(h => h.pitcher === selectedPitcher);
                }

                const total = pitches.length;
                if (total === 0) return null;

                const isStrike = (r) => r !== 'ball' && r !== 'hbp';
                const strikeCount = pitches.filter(p => isStrike(p.result)).length;
                const totalStrikeRate = (strikeCount / total) * 100;

                const byType = {};
                pitches.forEach(p => {
                    const pType = p.pitchType || '不明';
                    if (!byType[pType]) byType[pType] = { count: 0, strikes: 0 };
                    byType[pType].count++;
                    if (isStrike(p.result)) byType[pType].strikes++;
                });

                const chartData = Object.keys(byType).map((type) => ({
                    label: type,
                    count: byType[type].count,
                    percentage: (byType[type].count / total) * 100,
                    color: PITCH_COLOR_MAP[type] || DEFAULT_PITCH_COLOR
                })).sort((a, b) => b.count - a.count);

                const byInning = {};
                pitches.forEach(p => {
                    if (!byInning[p.inning]) byInning[p.inning] = { total: 0, strikes: 0, types: {} };
                    byInning[p.inning].total++;
                    if (isStrike(p.result)) byInning[p.inning].strikes++;
                    
                    const pType = p.pitchType || '不明';
                    if (!byInning[p.inning].types[pType]) byInning[p.inning].types[pType] = 0;
                    byInning[p.inning].types[pType]++;
                });

                return { total, strikeCount, totalStrikeRate, byType, chartData, byInning };
            }, [history, selectedPitcher]);

            if (!stats && pitchers.length === 0) return (
                <div className="p-4">
                    <button onClick={onBack} className="mb-4 text-gray-600 flex items-center"><span className="mr-1">←</span>戻る</button>
                    <div className="text-center text-gray-500 mt-10">データがまだありません</div>
                </div>
            );

            return (
                <div className="p-4 max-w-4xl mx-auto bg-white min-h-screen">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={onBack} className="bg-gray-500 text-white px-4 py-2 rounded font-bold shadow hover:bg-gray-600 flex items-center">戻る</button>
                        <div className="flex items-center">
                            <label className="text-sm font-bold mr-2 text-gray-700">投手:</label>
                            <select 
                                className="border rounded p-2 text-sm font-bold bg-white shadow-sm"
                                value={selectedPitcher}
                                onChange={(e) => setSelectedPitcher(e.target.value)}
                            >
                                <option value="all">チーム全員 (合計)</option>
                                {pitchers.map(p => <option key={p} value={p}>{p}</option>)}
                            </select>
                        </div>
                    </div>
                    
                    <h2 className="text-2xl font-bold text-indigo-800 mb-6 border-b pb-2">投球スタッツ分析</h2>

                    {!stats ? (
                        <div className="text-center text-gray-500 py-10">この投手のデータはありません</div>
                    ) : (
                        <>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                <div className="bg-blue-50 p-4 rounded shadow border border-blue-100 text-center">
                                    <div className="text-sm text-gray-500 font-bold">総投球数</div>
                                    <div className="text-3xl font-black text-blue-700">{stats.total}<span className="text-sm text-gray-500 ml-1">球</span></div>
                                </div>
                                <div className="bg-green-50 p-4 rounded shadow border border-green-100 text-center">
                                    <div className="text-sm text-gray-500 font-bold">ストライク率</div>
                                    <div className="text-3xl font-black text-green-700">{stats.totalStrikeRate.toFixed(1)}<span className="text-sm text-gray-500 ml-1">%</span></div>
                                </div>
                            </div>

                            <div className="grid md:grid-cols-2 gap-8 mb-8">
                                <div className="bg-white p-4 rounded shadow border">
                                    <h3 className="font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-2">球種配分</h3>
                                    <PieChart data={stats.chartData} />
                                </div>
                                
                                <div className="bg-white p-4 rounded shadow border">
                                    <h3 className="font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-2">球種別ストライク率</h3>
                                    <div className="space-y-3">
                                        {Object.keys(stats.byType).map(type => {
                                            const d = stats.byType[type];
                                            const rate = (d.strikes / d.count) * 100;
                                            return (
                                                <div key={type} className="flex items-center justify-between text-sm">
                                                    <div className="w-24 font-bold">{type}</div>
                                                    <div className="flex-1 mx-2 h-4 bg-gray-100 rounded overflow-hidden">
                                                        <div className="h-full bg-blue-500" style={{ width: `${rate}%` }}></div>
                                                    </div>
                                                    <div className="w-12 text-right">{rate.toFixed(0)}%</div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white p-4 rounded shadow border mb-8">
                                <h3 className="font-bold text-gray-700 mb-4 border-l-4 border-indigo-500 pl-2">イニング別ストライク率・球種内訳</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-center border-collapse">
                                        <thead>
                                            <tr className="bg-gray-100">
                                                <th className="border p-2 w-12">回</th>
                                                <th className="border p-2 w-16">球数</th>
                                                <th className="border p-2 w-16">S数</th>
                                                <th className="border p-2 w-20">S率</th>
                                                <th className="border p-2">球種内訳</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.keys(stats.byInning).sort((a,b)=>Number(a)-Number(b)).map(inn => {
                                                const d = stats.byInning[inn];
                                                const rate = (d.strikes / d.total) * 100;
                                                return (
                                                    <tr key={inn}>
                                                        <td className="border p-2 font-bold">{inn}</td>
                                                        <td className="border p-2">{d.total}</td>
                                                        <td className="border p-2">{d.strikes}</td>
                                                        <td className={`border p-2 font-bold ${rate >= 60 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {rate.toFixed(1)}%
                                                        </td>
                                                        <td className="border p-2 text-left">
                                                            <div className="flex flex-wrap gap-2">
                                                                {Object.keys(d.types).map(type => (
                                                                    <span key={type} className="inline-flex items-center bg-gray-100 rounded px-2 py-1 text-xs border shadow-sm">
                                                                        <span className="w-2 h-2 rounded-full mr-1" style={{ backgroundColor: PITCH_COLOR_MAP[type] || DEFAULT_PITCH_COLOR }}></span>
                                                                        <span className="font-bold text-gray-700">{type}</span>
                                                                        <span className="ml-1 bg-white rounded px-1 text-gray-600">{d.types[type]}</span>
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // --- App Component ---
        const App = () => {
            const [view, setView] = useState('setup');
            const [showRunnerModal, setShowRunnerModal] = useState(false); 
            const [showProcessingModal, setShowProcessingModal] = useState(false); 
            const [showPlayerMasterModal, setShowPlayerMasterModal] = useState(false); 
            const [selectedRunnerBase, setSelectedRunnerBase] = useState(null); 
            const [pendingPlay, setPendingPlay] = useState(null); 
            const [runnerMovements, setRunnerMovements] = useState({});
            const [logFilter, setLogFilter] = useState('current');
            const [undoStack, setUndoStack] = useState([]);
            const [warningMsg, setWarningMsg] = useState(null); // For custom alerts

            // Game State
            const [teams, setTeams] = useState({
                a: { name: 'Aチーム', players: createInitialRoster(), pitcher: { name: '先発投手', number: '1', throw: '右', bat: '右' } },
                b: { name: 'Bチーム', players: createInitialRoster(), pitcher: { name: '先発投手', number: '1', throw: '右', bat: '右' } }
            });
            
            const [battingOrder, setBattingOrder] = useState('a_first'); 

            // Player Directory
            const [playerMaster, setPlayerMaster] = useState([]);
            const [newPlayerName, setNewPlayerName] = useState('');
            const [newPlayerNumber, setNewPlayerNumber] = useState('');
            const [newPlayerTeam, setNewPlayerTeam] = useState('');
            const [newPlayerThrow, setNewPlayerThrow] = useState('右');
            const [newPlayerBat, setNewPlayerBat] = useState('右');
            
            const [editingPlayerId, setEditingPlayerId] = useState(null);

            useEffect(() => {
                const savedMaster = localStorage.getItem('sb_player_master');
                if (savedMaster) setPlayerMaster(JSON.parse(savedMaster));
            }, []);

            useEffect(() => {
                localStorage.setItem('sb_player_master', JSON.stringify(playerMaster));
            }, [playerMaster]);

            // Derived Lists
            const uniqueTeams = useMemo(() => {
                return [...new Set(playerMaster.map(p => p.team).filter(t => t))];
            }, [playerMaster]);

            const getPlayersForTeam = (teamName) => {
                const targetTeam = teamName ? teamName.trim() : "";
                if (!targetTeam) return playerMaster;
                const filtered = playerMaster.filter(p => {
                    const pTeam = p.team ? p.team.trim() : "";
                    return pTeam === targetTeam || pTeam === "";
                });
                return filtered.length > 0 ? filtered : playerMaster;
            };

            const [gameState, setGameState] = useState({
                inning: 1, isTop: true, outs: 0, balls: 0, strikes: 0,
                score: { top: 0, bottom: 0 },
                lineScore: { top: {}, bottom: {} },
                runners: { 1: false, 2: false, 3: false },
                currentBatterIndex: { top: 0, bottom: 0 },
                history: [] 
            });

            const [currentPitch, setCurrentPitch] = useState({ zone: null, type: 'ストレート', speed: '', location: '' });

            // Accessors
            const getTopTeam = () => battingOrder === 'a_first' ? teams.a : teams.b;
            const getBottomTeam = () => battingOrder === 'a_first' ? teams.b : teams.a;
            const getCurrentTeam = () => gameState.isTop ? getTopTeam() : getBottomTeam();
            const getDefendingTeam = () => gameState.isTop ? getBottomTeam() : getTopTeam();
            const getCurrentBatter = () => getCurrentTeam().players[gameState.currentBatterIndex[gameState.isTop ? 'top' : 'bottom']];
            const getCurrentPitcher = () => getDefendingTeam().pitcher;

            const pushToUndo = () => setUndoStack(prev => [...prev, JSON.parse(JSON.stringify(gameState))]);
            const handleUndo = () => {
                if (undoStack.length === 0) return;
                const prev = undoStack[undoStack.length - 1];
                setGameState(prev);
                setUndoStack(old => old.slice(0, -1));
            };

            const handleZoneSelect = (index) => setCurrentPitch(prev => ({ ...prev, zone: index }));
            const handlePitchTypeSelect = (type) => setCurrentPitch(prev => ({ ...prev, type }));
            const handleLocationSelect = (pos) => setCurrentPitch(prev => ({ ...prev, location: pos }));
            
            const updateLineScore = (state, scoreAdded) => {
                if (scoreAdded > 0) {
                    const side = state.isTop ? 'top' : 'bottom';
                    if (state.lineScore[side][state.inning] === undefined) state.lineScore[side][state.inning] = 0;
                    state.lineScore[side][state.inning] += scoreAdded;
                    state.score[side] += scoreAdded;
                }
            };

            const processPlay = (resultKey) => {
                const isRunnerOn = gameState.runners[1] || gameState.runners[2] || gameState.runners[3];
                const complexTypes = ['hit1', 'hit2', 'hit3', 'error', 'out_goro', 'out_fly'];
                if (isRunnerOn && complexTypes.includes(resultKey)) {
                    setPendingPlay({ resultKey: resultKey, runnerState: { ...gameState.runners } });
                    setRunnerMovements({ 1: gameState.runners[1]?'stay':null, 2: gameState.runners[2]?'stay':null, 3: gameState.runners[3]?'stay':null });
                    setShowProcessingModal(true);
                    return;
                }
                resolvePlay(resultKey);
            };

            const resolvePlay = (resultKey, movements = null) => {
                pushToUndo();
                const newState = { ...gameState };
                let actualResult = resultKey;
                let detailResult = '';

                if (resultKey === 'ball' && newState.balls >= 3) { actualResult = 'walk'; detailResult = 'フォアボール(自動)'; }
                else if ((resultKey === 'strike_look' || resultKey === 'strike_swing') && newState.strikes >= 2) { actualResult = 'out_so'; detailResult = '三振(自動)'; }

                let scoreAdded = 0;
                let endAtBat = false;

                if (movements) {
                    newState.runners = { 1: false, 2: false, 3: false };
                    [3, 2, 1].forEach(base => {
                        const move = movements[base];
                        if (move === 'home') scoreAdded++;
                        else if (move === '2B') newState.runners[2] = true;
                        else if (move === '3B') newState.runners[3] = true;
                        else if (move === 'stay') newState.runners[base] = true;
                        else if (move === 'out') newState.outs++;
                    });
                }

                switch (actualResult) {
                    case 'ball': newState.balls++; break;
                    case 'strike_look': case 'strike_swing': newState.strikes++; break;
                    case 'foul': if (newState.strikes < 2) newState.strikes++; break;
                    case 'out_so': newState.outs++; endAtBat = true; break;
                    case 'walk': case 'hbp': 
                        if (!movements) scoreAdded += handleWalk(newState); 
                        else newState.runners[1] = true; 
                        endAtBat = true; break;
                    case 'hit1': case 'error': 
                        if (!movements) scoreAdded += handleSimpleHit(newState, 1);
                        else newState.runners[1] = true; 
                        endAtBat = true; break;
                    case 'hit2': 
                        if (!movements) scoreAdded += handleSimpleHit(newState, 2);
                        else newState.runners[2] = true; 
                        endAtBat = true; break;
                    case 'hit3': 
                        if (!movements) scoreAdded += handleSimpleHit(newState, 3);
                        else newState.runners[3] = true; 
                        endAtBat = true; break;
                    case 'hr': 
                        let runnersOn = (newState.runners[1]?1:0) + (newState.runners[2]?1:0) + (newState.runners[3]?1:0);
                        scoreAdded += runnersOn + 1; newState.runners = {1:false, 2:false, 3:false}; endAtBat = true; break;
                    case 'out_goro': case 'out_fly': 
                        if (!movements) newState.outs++; else newState.outs++; 
                        endAtBat = true; break;
                }

                updateLineScore(newState, scoreAdded);

                const pitchRecord = {
                    id: Date.now(),
                    inning: newState.inning, isTop: newState.isTop,
                    batter: getCurrentBatter().name, pitcher: getCurrentPitcher().name,
                    pitchType: currentPitch.type, speed: currentPitch.speed, zoneIndex: currentPitch.zone,
                    zoneLabel: currentPitch.zone !== null ? ZONE_LABELS[currentPitch.zone] : '不明',
                    result: resultKey, location: currentPitch.location,
                    countBefore: { b: gameState.balls, s: gameState.strikes, o: gameState.outs },
                    scoreBefore: { ...gameState.score },
                    playResult: detailResult || RESULTS.find(r => r.type === actualResult)?.label || actualResult
                };

                if (newState.outs >= 3) {
                    newState.outs = 0; newState.balls = 0; newState.strikes = 0;
                    newState.runners = { 1: false, 2: false, 3: false };
                    if (newState.isTop) newState.isTop = false; else { newState.isTop = true; newState.inning++; }
                } else if (endAtBat) {
                    newState.balls = 0; newState.strikes = 0;
                    const side = gameState.isTop ? 'top' : 'bottom';
                    newState.currentBatterIndex[side] = (newState.currentBatterIndex[side] + 1) % 9;
                }
                
                pitchRecord.countAfter = { b: newState.balls, s: newState.strikes, o: newState.outs };
                setGameState(prev => ({ ...newState, history: [pitchRecord, ...prev.history] }));
                setCurrentPitch(prev => ({ ...prev, zone: null, location: '' }));
                setShowProcessingModal(false); setPendingPlay(null);
            };

            const handleWalk = (state) => {
                let runs = 0;
                if (state.runners[1] && state.runners[2] && state.runners[3]) runs = 1;
                else if (state.runners[1] && state.runners[2]) state.runners[3] = true;
                else if (state.runners[1]) state.runners[2] = true;
                state.runners[1] = true;
                return runs;
            };

            const handleSimpleHit = (state, bases) => {
                let runs = 0;
                const runners = state.runners;
                if (bases === 1) runs += handleWalk(state); 
                else if (bases === 2) {
                    if (runners[3]) { runs++; runners[3] = false; }
                    if (runners[2]) { runs++; runners[2] = false; }
                    if (runners[1]) { runners[3] = true; runners[1] = false; }
                    runners[2] = true;
                } else if (bases === 3) {
                    runs += (runners[1]?1:0) + (runners[2]?1:0) + (runners[3]?1:0);
                    state.runners = {1:false, 2:false, 3:true};
                }
                return runs;
            };

            const handleMovementChange = (base, value) => setRunnerMovements(prev => ({ ...prev, [base]: value }));
            const confirmProcessing = () => resolvePlay(pendingPlay.resultKey, runnerMovements);

            const handleIndividualRunnerMove = (fromBase, actionType) => {
                if (actionType === 'advance') {
                    const toBase = fromBase + 1;
                    if (toBase <= 3 && gameState.runners[toBase]) { 
                        setWarningMsg("ランナーが重複します。前のランナーを先に操作してください。");
                        return; 
                    }
                }
                pushToUndo();
                const newState = { ...gameState };
                let logText = '';
                newState.runners[fromBase] = false;
                let scoreAdded = 0;

                if (actionType === 'advance') {
                    if (fromBase === 3) { scoreAdded = 1; logText = '本盗/進塁(得点)'; }
                    else { newState.runners[fromBase + 1] = true; logText = `${fromBase}塁→${fromBase+1}塁 盗塁/進塁`; }
                } else if (actionType === 'out') {
                    newState.outs++; logText = `${fromBase}塁走者アウト(牽制/盗塁死)`;
                }

                updateLineScore(newState, scoreAdded);
                 if (newState.outs >= 3) {
                    newState.outs = 0; newState.balls = 0; newState.strikes = 0;
                    newState.runners = { 1: false, 2: false, 3: false };
                    if (newState.isTop) newState.isTop = false; else { newState.isTop = true; newState.inning++; }
                }

                const sysRecord = {
                    id: Date.now(), inning: newState.inning, isTop: newState.isTop,
                    batter: getCurrentBatter().name, pitcher: getCurrentPitcher().name,
                    pitchType: '-', speed: '-', zoneIndex: null, zoneLabel: '-',
                    result: '状況変化', playResult: logText
                };
                setGameState(prev => ({ ...newState, history: [sysRecord, ...prev.history] }));
                setSelectedRunnerBase(null);
            };

            const handleClearRunners = () => {
                pushToUndo();
                const newState = { ...gameState };
                newState.runners = {1:false, 2:false, 3:false};
                setGameState(prev => ({ ...newState, history: [{...prev.history[0], id: Date.now(), result: '状況変化', playResult: '走者一掃'}] }));
                setSelectedRunnerBase(null);
            };

            // Player Master Logic
            const handleAddPlayer = () => {
                if (!newPlayerName.trim()) return;
                const newPlayer = {
                    id: Date.now(), name: newPlayerName.trim(), number: newPlayerNumber.trim(),
                    team: newPlayerTeam.trim(), throw: newPlayerThrow, bat: newPlayerBat
                };
                setPlayerMaster(prev => [...prev, newPlayer]);
                resetPlayerForm();
            };

            const handleUpdatePlayer = () => {
                if (!newPlayerName.trim()) return;
                setPlayerMaster(prev => prev.map(p => p.id === editingPlayerId ? {
                    ...p, name: newPlayerName.trim(), number: newPlayerNumber.trim(),
                    team: newPlayerTeam.trim(), throw: newPlayerThrow, bat: newPlayerBat
                } : p));
                setEditingPlayerId(null);
                resetPlayerForm();
            };

            const handleEditPlayer = (p) => {
                setEditingPlayerId(p.id);
                setNewPlayerName(p.name);
                setNewPlayerNumber(p.number);
                setNewPlayerTeam(p.team);
                setNewPlayerThrow(p.throw);
                setNewPlayerBat(p.bat);
            };

            const handleCancelEdit = () => {
                setEditingPlayerId(null);
                resetPlayerForm();
            };

            const resetPlayerForm = () => {
                setNewPlayerName(''); setNewPlayerNumber('');
            };

            const handleDeletePlayer = (id) => setPlayerMaster(prev => prev.filter(p => p.id !== id));

            const saveCurrentRosterToMaster = () => {
                const newPlayers = [];
                const currentNames = new Set(playerMaster.map(p => p.name));
                const processPlayer = (p, teamName) => {
                    if (p.name && !p.name.includes("選手") && !currentNames.has(p.name)) {
                        newPlayers.push({
                            id: Date.now() + Math.random(), name: p.name, number: p.number || '',
                            team: teamName || '', throw: p.throw || '右', bat: p.bat || '右'
                        });
                        currentNames.add(p.name);
                    }
                };
                [...teams.a.players, teams.a.pitcher].forEach(p => processPlayer(p, teams.a.name));
                [...teams.b.players, teams.b.pitcher].forEach(p => processPlayer(p, teams.b.name));
                if (newPlayers.length > 0) {
                    setPlayerMaster(prev => [...prev, ...newPlayers]);
                    // Using console for info instead of alert if possible, but user asked for functionality. 
                    // Using setWarningMsg for feedback if appropriate, but keeping alert for major success/info to be simple.
                    // Actually, let's use the warningMsg modal for consistency.
                    setWarningMsg(`${newPlayers.length}名の選手を名鑑に登録しました`);
                } else setWarningMsg('新しい選手は見つかりませんでした');
            };

            const handleRosterChange = (teamKey, index, field, value) => {
                const newTeams = { ...teams };
                if (index === null) {
                    newTeams[teamKey][field] = value;
                } else {
                    let target;
                    if (index === 'pitcher') target = newTeams[teamKey].pitcher;
                    else target = newTeams[teamKey].players[index];
                    target[field] = value;
                    if (field === 'name') {
                        const match = playerMaster.find(p => p.name === value);
                        if (match) {
                            if (match.number) target.number = match.number;
                            if (match.throw) target.throw = match.throw;
                            if (match.bat) target.bat = match.bat;
                        }
                    }
                }
                setTeams(newTeams);
            };

            const exportCSV = () => {
                const header = "日時,回,表裏,攻撃チーム,投手,打者,球種,球速,コース,打球方向,結果,詳細\n";
                const rows = gameState.history.map(p => {
                    const teamName = p.isTop ? getTopTeam().name : getBottomTeam().name;
                    const dateStr = new Date(p.id).toLocaleString();
                    const topBottom = p.isTop ? "表" : "裏";
                    return `${dateStr},${p.inning},${topBottom},${teamName},${p.pitcher},${p.batter},${p.pitchType},${p.speed},${p.zoneLabel},${p.location || ''},${p.result},${p.playResult || ''}`;
                }).join("\n");
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blob = new Blob([bom, header + rows], { type: "text/csv" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `softball_data_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
            };

            const getFilteredHistory = () => {
                if (logFilter === 'none') return [];
                if (logFilter === 'current') return gameState.history.filter(p => p.inning === gameState.inning);
                return gameState.history;
            };

            const getBgColor = (val) => {
                if (val === '右') return 'bg-blue-100';
                if (val === '左') return 'bg-pink-100';
                if (val === '両') return 'bg-yellow-100';
                return 'bg-white';
            };

            if (view === 'stats') {
                return <StatsView history={gameState.history} onBack={() => setView('game')} />;
            }

            if (view === 'setup') {
                return (
                    <div className="max-w-4xl mx-auto p-4 pb-20 relative">
                        {/* Warning Modal */}
                        {warningMsg && (
                            <div className="absolute inset-0 z-[60] flex items-center justify-center p-4 bg-black/30">
                                <div className="bg-white p-6 rounded shadow-lg max-w-sm w-full text-center">
                                    <div className="flex justify-center mb-2 text-indigo-600"><IconActivity /></div>
                                    <p className="mb-4 font-bold">{warningMsg}</p>
                                    <button onClick={() => setWarningMsg(null)} className="bg-gray-500 text-white px-4 py-2 rounded">閉じる</button>
                                </div>
                            </div>
                        )}

                        {/* Dynamic Datalists for A and B Teams */}
                        <datalist id="team-names">
                            {uniqueTeams.map((t, i) => <option key={i} value={t} />)}
                        </datalist>
                        <datalist id="team-a-players">
                            {getPlayersForTeam(teams.a.name).map(p => <option key={p.id} value={p.name}>{p.number ? `#${p.number}` : ''}</option>)}
                        </datalist>
                        <datalist id="team-b-players">
                            {getPlayersForTeam(teams.b.name).map(p => <option key={p.id} value={p.name}>{p.number ? `#${p.number}` : ''}</option>)}
                        </datalist>

                        <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                            <h1 className="text-2xl font-bold text-green-800 flex items-center"><span className="mr-2"><IconActivity /></span> チーム・オーダー登録</h1>
                            <div className="flex space-x-2">
                                <button onClick={() => setShowPlayerMasterModal(true)} className="bg-indigo-600 text-white px-3 py-2 rounded text-sm font-bold flex items-center shadow hover:bg-indigo-700"><span className="mr-1"><IconUsers /></span> 選手管理(名鑑)</button>
                                <button onClick={saveCurrentRosterToMaster} className="bg-blue-500 text-white px-3 py-2 rounded text-sm font-bold flex items-center shadow hover:bg-blue-600"><span className="mr-1"><IconUserPlus /></span> 今のオーダーを登録</button>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-6">
                            {['a', 'b'].map(teamKey => (
                                <div key={teamKey} className="bg-white p-4 rounded shadow">
                                    <div className="flex justify-between items-center mb-2 bg-gray-100 p-2 rounded">
                                        <h2 className="font-bold text-lg">{teamKey === 'a' ? 'Aチーム (左)' : 'Bチーム (右)'}</h2>
                                        <div className="flex bg-white rounded shadow-sm overflow-hidden border">
                                            <button 
                                                className={`px-3 py-1 text-xs font-bold ${
                                                    (teamKey === 'a' && battingOrder === 'a_first') || (teamKey === 'b' && battingOrder === 'b_first') 
                                                    ? 'bg-green-600 text-white' : 'text-gray-600 hover:bg-gray-50'
                                                }`}
                                                onClick={() => setBattingOrder(teamKey === 'a' ? 'a_first' : 'b_first')}
                                            >先攻</button>
                                            <button 
                                                className={`px-3 py-1 text-xs font-bold ${
                                                    (teamKey === 'a' && battingOrder === 'b_first') || (teamKey === 'b' && battingOrder === 'a_first') 
                                                    ? 'bg-green-600 text-white' : 'text-gray-600 hover:bg-gray-50'
                                                }`}
                                                onClick={() => setBattingOrder(teamKey === 'a' ? 'b_first' : 'a_first')}
                                            >後攻</button>
                                        </div>
                                    </div>
                                    <input 
                                        className="w-full mb-4 p-2 border rounded font-bold" 
                                        value={teams[teamKey].name} 
                                        onChange={(e) => handleRosterChange(teamKey, null, 'name', e.target.value)} 
                                        list="team-names" 
                                        placeholder="チーム名 (名鑑から選択可)" 
                                    />
                                    
                                    <div className="flex items-center space-x-1 border-b-2 border-gray-300 pb-1 mb-1 text-xs font-bold text-gray-600 text-center">
                                        <div className="w-6">順</div>
                                        <div className="w-10">番号</div>
                                        <div className="flex-1">選手名</div>
                                        <div className="w-12">投</div>
                                        <div className="w-12">打</div>
                                    </div>

                                    <div className="space-y-2">
                                        {teams[teamKey].players.map((p, i) => (
                                            <div key={i} className="flex items-center space-x-1 border-b pb-1">
                                                <div className="w-6 flex-shrink-0 flex items-center justify-center font-bold bg-green-100 rounded text-sm h-8">{i+1}</div>
                                                <input className="w-10 p-1 border rounded text-center text-sm" value={p.number} onChange={(e) => handleRosterChange(teamKey, i, 'number', e.target.value)} placeholder="#" />
                                                <input 
                                                    className="flex-1 p-1 border rounded text-sm" 
                                                    value={p.name} 
                                                    onChange={(e) => handleRosterChange(teamKey, i, 'name', e.target.value)}
                                                    list={`team-${teamKey}-players`} 
                                                    placeholder="選手名"
                                                />
                                                <select className={`w-12 p-1 border rounded text-xs text-center font-bold ${getBgColor(p.throw)}`} value={p.throw} onChange={(e) => handleRosterChange(teamKey, i, 'throw', e.target.value)}><option value="右">右</option><option value="左">左</option></select>
                                                <select className={`w-12 p-1 border rounded text-xs text-center font-bold ${getBgColor(p.bat)}`} value={p.bat} onChange={(e) => handleRosterChange(teamKey, i, 'bat', e.target.value)}><option value="右">右</option><option value="左">左</option><option value="両">両</option></select>
                                            </div>
                                        ))}
                                        <div className="mt-4 pt-2 border-t">
                                            <div className="flex items-center space-x-1">
                                                <div className="w-6 flex-shrink-0 flex items-center justify-center font-bold bg-yellow-100 rounded text-sm h-8">P</div>
                                                <input className="w-10 p-1 border rounded text-center text-sm" value={teams[teamKey].pitcher.number} onChange={(e) => handleRosterChange(teamKey, 'pitcher', 'number', e.target.value)} placeholder="#" />
                                                <input className="flex-1 p-1 border rounded text-sm" value={teams[teamKey].pitcher.name} onChange={(e) => handleRosterChange(teamKey, 'pitcher', 'name', e.target.value)} list={`team-${teamKey}-players`} placeholder="投手名" />
                                                <select className={`w-12 p-1 border rounded text-xs text-center font-bold ${getBgColor(teams[teamKey].pitcher.throw)}`} value={teams[teamKey].pitcher.throw} onChange={(e) => handleRosterChange(teamKey, 'pitcher', 'throw', e.target.value)}><option value="右">右</option><option value="左">左</option></select>
                                                <select className={`w-12 p-1 border rounded text-xs text-center font-bold ${getBgColor(teams[teamKey].pitcher.bat)}`} value={teams[teamKey].pitcher.bat} onChange={(e) => handleRosterChange(teamKey, 'pitcher', 'bat', e.target.value)}><option value="右">右</option><option value="左">左</option><option value="両">両</option></select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="mt-8 text-center">
                            <button onClick={() => setView('game')} className="bg-green-600 text-white px-8 py-3 rounded-lg text-xl font-bold hover:bg-green-700 shadow-lg flex items-center justify-center mx-auto">試合開始 <span className="ml-2"><IconArrowRight /></span></button>
                        </div>

                        {showPlayerMasterModal && (
                            <div className="absolute inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                                <div className="bg-white rounded-lg shadow-xl p-4 w-full max-w-2xl h-[85vh] flex flex-col">
                                    <h3 className="font-bold text-lg mb-4 border-b pb-2 flex justify-between items-center"><span>選手名鑑 (登録数: {playerMaster.length})</span><button onClick={() => setShowPlayerMasterModal(false)} className="text-gray-500 hover:text-gray-700">✕</button></h3>
                                    <div className={`p-3 rounded mb-4 ${editingPlayerId ? 'bg-blue-50 border-blue-200 border' : 'bg-gray-100'}`}>
                                        <div className="text-xs font-bold text-gray-600 mb-2">{editingPlayerId ? '選手情報編集' : '新規登録'}</div>
                                        <div className="grid grid-cols-12 gap-2 mb-2">
                                            <input className="col-span-3 border rounded p-1 text-sm" list="team-names" placeholder="チーム名" value={newPlayerTeam} onChange={(e) => setNewPlayerTeam(e.target.value)} />
                                            <input className="col-span-2 border rounded p-1 text-center text-sm" placeholder="No." value={newPlayerNumber} onChange={(e) => setNewPlayerNumber(e.target.value)} />
                                            <input className="col-span-7 border rounded p-1 text-sm" placeholder="名前" value={newPlayerName} onChange={(e) => setNewPlayerName(e.target.value)} />
                                        </div>
                                        <div className="flex gap-2 justify-end">
                                            <div className="flex items-center bg-white border rounded px-2"><span className="text-xs text-gray-500 mr-2">投:</span><label className="mr-2 text-sm"><input type="radio" name="m_throw" checked={newPlayerThrow==='右'} onChange={()=>setNewPlayerThrow('右')} />右</label><label className="text-sm"><input type="radio" name="m_throw" checked={newPlayerThrow==='左'} onChange={()=>setNewPlayerThrow('左')} />左</label></div>
                                            <div className="flex items-center bg-white border rounded px-2"><span className="text-xs text-gray-500 mr-2">打:</span><label className="mr-2 text-sm"><input type="radio" name="m_bat" checked={newPlayerBat==='右'} onChange={()=>setNewPlayerBat('右')} />右</label><label className="mr-2 text-sm"><input type="radio" name="m_bat" checked={newPlayerBat==='左'} onChange={()=>setNewPlayerBat('左')} />左</label><label className="text-sm"><input type="radio" name="m_bat" checked={newPlayerBat==='両'} onChange={()=>setNewPlayerBat('両')} />両</label></div>
                                            {editingPlayerId ? (
                                                <>
                                                    <button onClick={handleCancelEdit} className="bg-gray-500 text-white px-4 py-1 rounded font-bold hover:bg-gray-600 text-sm">中止</button>
                                                    <button onClick={handleUpdatePlayer} className="bg-blue-600 text-white px-4 py-1 rounded font-bold hover:bg-blue-700 text-sm">更新</button>
                                                </>
                                            ) : (
                                                <button onClick={handleAddPlayer} className="bg-green-600 text-white px-4 py-1 rounded font-bold hover:bg-green-700 text-sm">追加</button>
                                            )}
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto border rounded bg-gray-50 p-2">
                                        {playerMaster.length === 0 && <div className="text-gray-400 text-center py-4">登録選手がいません</div>}
                                        {playerMaster.map(p => (
                                            <div key={p.id} className="flex justify-between items-center bg-white p-2 mb-1 rounded shadow-sm text-sm">
                                                <div className="flex items-center flex-1">
                                                    <span className="text-xs text-gray-500 w-24 truncate mr-2">{p.team}</span>
                                                    <span className="font-mono bg-gray-200 px-2 rounded mr-2 w-10 text-center">{p.number || '-'}</span>
                                                    <span className="font-bold flex-1">{p.name}</span>
                                                    <span className={`text-xs px-1 rounded mr-1 ${getBgColor(p.throw)}`}>投:{p.throw}</span>
                                                    <span className={`text-xs px-1 rounded ${getBgColor(p.bat)}`}>打:{p.bat}</span>
                                                </div>
                                                <div className="flex space-x-1 ml-2">
                                                    <button onClick={() => handleEditPlayer(p)} className="text-blue-500 hover:text-blue-700 text-xs border border-blue-200 px-2 py-1 rounded flex items-center"><span className="mr-1"><IconEdit /></span>編集</button>
                                                    <button onClick={() => handleDeletePlayer(p.id)} className="text-red-500 hover:text-red-700 text-xs border border-red-200 px-2 py-1 rounded">削除</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto md:max-w-6xl bg-gray-50 min-h-screen flex flex-col relative">
                    {warningMsg && (
                        <div className="absolute inset-0 z-[60] flex items-center justify-center p-4 bg-black/30">
                            <div className="bg-white p-6 rounded shadow-lg max-w-sm w-full text-center animate-bounce-in">
                                <div className="flex justify-center mb-2"><IconAlert /></div>
                                <p className="mb-4 font-bold text-gray-800">{warningMsg}</p>
                                <button onClick={() => setWarningMsg(null)} className="bg-gray-600 text-white px-6 py-2 rounded hover:bg-gray-700">閉じる</button>
                            </div>
                        </div>
                    )}

                    <div className="bg-green-800 text-white p-2 shadow-md sticky top-0 z-50">
                        <div className="flex justify-between items-start mb-1 max-w-4xl mx-auto w-full">
                            <div className="w-2/3 overflow-x-auto">
                                <table className="text-xs text-center w-full border-collapse">
                                    <thead>
                                        <tr className="border-b border-green-600">
                                            <th className="px-1 text-left whitespace-nowrap">チーム</th>
                                            {[...Array(Math.max(7, gameState.inning))].map((_, i) => <th key={i} className={`px-1 w-6 ${gameState.inning === i+1 ? 'bg-green-700' : ''}`}>{i+1}</th>)}
                                            <th className="px-2 font-bold text-yellow-300">R</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td className="text-left font-bold whitespace-nowrap pr-2">{getTopTeam().name}</td>
                                            {[...Array(Math.max(7, gameState.inning))].map((_, i) => {
                                                const show = (i+1 < gameState.inning) || (i+1 === gameState.inning && gameState.lineScore.top[i+1] !== undefined);
                                                return <td key={i} className="border-r border-green-700">{show ? (gameState.lineScore.top[i+1] || 0) : ''}</td>
                                            })}
                                            <td className="font-bold text-lg text-yellow-300">{gameState.score.top}</td>
                                        </tr>
                                        <tr>
                                            <td className="text-left font-bold whitespace-nowrap pr-2">{getBottomTeam().name}</td>
                                            {[...Array(Math.max(7, gameState.inning))].map((_, i) => {
                                                const show = (i+1 < gameState.inning) || (i+1 === gameState.inning && !gameState.isTop && gameState.lineScore.bottom[i+1] !== undefined);
                                                return <td key={i} className="border-r border-green-700">{show ? (gameState.lineScore.bottom[i+1] || 0) : ''}</td>
                                            })}
                                            <td className="font-bold text-lg text-yellow-300">{gameState.score.bottom}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div className="w-1/3 flex justify-end pr-2 pl-2">
                                <div className="text-right mr-2">
                                    <div className="text-2xl font-black font-mono leading-none">{gameState.inning}<span className="text-sm">{gameState.isTop ? '表' : '裏'}</span></div>
                                    <div className="text-xs text-green-200">{gameState.isTop ? getTopTeam().name.substring(0,6) : getBottomTeam().name.substring(0,6)}</div>
                                </div>
                                <svg width="60" height="45" viewBox="0 0 100 80">
                                    <path d="M50 5 L65 20 L50 35 L35 20 Z" fill={gameState.runners[2] ? "#fbbf24" : "rgba(255,255,255,0.3)"} stroke="white" strokeWidth="2"/>
                                    <path d="M15 35 L30 50 L15 65 L0 50 Z" fill={gameState.runners[3] ? "#fbbf24" : "rgba(255,255,255,0.3)"} stroke="white" strokeWidth="2"/>
                                    <path d="M85 35 L100 50 L85 65 L70 50 Z" fill={gameState.runners[1] ? "#fbbf24" : "rgba(255,255,255,0.3)"} stroke="white" strokeWidth="2"/>
                                </svg>
                            </div>
                        </div>
                        <div className="flex justify-around bg-green-900 rounded py-1 max-w-4xl mx-auto">
                            <div className="flex items-center space-x-2"><span className="font-bold text-green-300">B</span> {[...Array(3)].map((_,i) => <div key={i} className={`w-3 h-3 rounded-full ${i < gameState.balls ? 'bg-green-500' : 'bg-gray-700'}`}></div>)}</div>
                            <div className="flex items-center space-x-2"><span className="font-bold text-yellow-300">S</span> {[...Array(2)].map((_,i) => <div key={i} className={`w-3 h-3 rounded-full ${i < gameState.strikes ? 'bg-yellow-500' : 'bg-gray-700'}`}></div>)}</div>
                            <div className="flex items-center space-x-2"><span className="font-bold text-red-300">O</span> {[...Array(2)].map((_,i) => <div key={i} className={`w-3 h-3 rounded-full ${i < gameState.outs ? 'bg-red-500' : 'bg-gray-700'}`}></div>)}</div>
                        </div>
                    </div>

                    <div className="flex-1 md:flex md:flex-row overflow-hidden">
                        <div className="p-2 md:w-1/2 flex flex-col items-center border-r bg-white overflow-y-auto">
                            <div className="w-full bg-blue-50 p-2 mb-2 rounded border border-blue-200 text-sm flex justify-between items-center">
                                <div><div className="text-xs text-gray-500">ピッチャー</div><div className="font-bold text-sm truncate w-24">{getCurrentPitcher().name}</div></div>
                                <div className="text-xl font-bold text-blue-800">VS</div>
                                <div className="text-right"><div className="text-xs text-gray-500">バッター</div><div className="font-bold text-lg truncate w-24 text-right">{getCurrentBatter().name}</div></div>
                            </div>

                            <div className="flex items-start justify-center mb-4 w-full">
                                <div className="zone-grid shadow-lg border-2 border-gray-800 mr-2">
                                    {[...Array(25)].map((_, i) => (
                                        <div key={i} onClick={() => handleZoneSelect(i)} className={`zone-cell ${STRIKE_INDICES.includes(i) ? 'strike-zone' : ''} ${currentPitch.zone === i ? 'selected' : ''}`}>
                                            {i === 12 && <span className="w-2 h-2 bg-gray-300 rounded-full opacity-50"></span>}
                                        </div>
                                    ))}
                                </div>
                                <div className="flex flex-col space-y-2 pt-1">
                                    <button onClick={() => processPlay('ball')} className="btn-count bg-green-600 hover:bg-green-700"><span className="text-lg">ボール</span></button>
                                    <button onClick={() => processPlay('strike_look')} className="btn-count bg-yellow-500 text-black hover:bg-yellow-400"><span className="text-xs">ストライク</span><span className="text-lg">見逃し</span></button>
                                    <button onClick={() => processPlay('strike_swing')} className="btn-count bg-yellow-500 text-black hover:bg-yellow-400"><span className="text-xs">ストライク</span><span className="text-lg">空振り</span></button>
                                </div>
                            </div>

                            <div className="w-full px-1 mb-2">
                                <div className="flex space-x-1 overflow-x-auto pb-2 scrollbar-hide">
                                    {PITCH_TYPES.map(type => (
                                        <button key={type} onClick={() => handlePitchTypeSelect(type)} className={`px-3 py-2 text-sm rounded-full whitespace-nowrap border font-bold ${currentPitch.type === type ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700'}`}>{type}</button>
                                    ))}
                                </div>
                                <div className="flex items-center justify-center space-x-2 mt-2">
                                    <span className="text-sm font-bold text-gray-500">球速:</span>
                                    <input type="number" className="border rounded px-2 py-1 w-20 text-center text-lg" value={currentPitch.speed} onChange={(e) => setCurrentPitch(p => ({...p, speed: e.target.value}))} />
                                    <span className="text-sm text-gray-400">km/h</span>
                                </div>
                            </div>
                        </div>

                        <div className="md:w-1/2 flex flex-col h-full bg-gray-50 pb-28 md:pb-0 relative border-l">
                            <div className="p-2 border-b bg-gray-100 grid grid-cols-2 gap-2">
                                <button onClick={() => setView('setup')} className="bg-gray-500 text-white py-2 rounded flex justify-center items-center font-bold text-sm"><span className="mr-1"><IconSettings /></span> 設定/交代</button>
                                <div className="grid grid-cols-2 gap-1">
                                    <button onClick={exportCSV} className="bg-green-700 text-white py-2 rounded flex justify-center items-center font-bold text-sm"><span className="mr-1"><IconSave /></span> CSV出力</button>
                                    <button onClick={() => setView('stats')} className="bg-purple-600 text-white py-2 rounded flex justify-center items-center font-bold text-sm hover:bg-purple-700"><span className="mr-1"><IconPieChart /></span> 成績</button>
                                </div>
                                <button onClick={handleUndo} disabled={undoStack.length === 0} className={`py-2 rounded text-xs font-bold flex justify-center items-center ${undoStack.length === 0 ? 'bg-gray-300 text-gray-500' : 'bg-gray-600 text-white hover:bg-gray-700'}`}><span className="mr-1"><IconUndo /></span> 1つ戻す</button>
                                <button onClick={() => { setShowRunnerModal(true); setSelectedRunnerBase(null); }} className="py-2 bg-orange-600 text-white rounded text-xs font-bold flex justify-center items-center hover:bg-orange-700"><span className="mr-1"><IconRun /></span> 走塁・状況</button>
                            </div>

                            <div className="p-2 bg-white border-b shadow-sm space-y-2">
                                <div className="grid grid-cols-4 gap-2">
                                    <button onClick={() => processPlay('foul')} className="btn-action bg-yellow-500 text-black col-span-2 hover:bg-yellow-400">ファウル</button>
                                    <button onClick={() => processPlay('hbp')} className="btn-action bg-black text-white hover:bg-gray-800">死球</button>
                                    <button onClick={() => processPlay('error')} className="btn-action bg-orange-500">エラー</button>
                                    <button onClick={() => processPlay('out_goro')} className="btn-action bg-red-500 col-span-2">ゴロアウト</button>
                                    <button onClick={() => processPlay('out_fly')} className="btn-action bg-red-500 col-span-2">フライアウト</button>
                                    <button onClick={() => processPlay('hit1')} className="btn-action bg-blue-400">単打</button>
                                    <button onClick={() => processPlay('hit2')} className="btn-action bg-blue-400">二塁打</button>
                                    <button onClick={() => processPlay('hit3')} className="btn-action bg-blue-400">三塁打</button>
                                    <button onClick={() => processPlay('hr')} className="btn-action bg-blue-400">本塁打</button>
                                </div>
                                <div className="pt-2 border-t">
                                    <div className="text-xs font-bold text-gray-500 mb-1 text-center">打球方向 (任意)</div>
                                    <div className="grid grid-cols-9 gap-1">
                                        {POSITIONS.map(pos => (
                                            <button key={pos} onClick={() => handleLocationSelect(pos)} className={`px-1 py-2 text-xs border rounded font-bold text-center transition-colors ${currentPitch.location === pos ? 'bg-indigo-600 text-white border-indigo-600 shadow-inner' : 'bg-white text-gray-700 hover:bg-gray-100'}`}>{pos}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="flex items-center justify-between px-3 py-1 bg-gray-200 text-xs font-bold text-gray-600 border-b">
                                <div className="flex items-center"><IconList /><span className="ml-1">記録ログ</span></div>
                                <div className="flex space-x-1">
                                    <button onClick={() => setLogFilter('current')} className={`px-2 py-1 rounded ${logFilter === 'current' ? 'bg-white shadow text-indigo-600' : 'hover:bg-gray-300'}`}>今の回のみ</button>
                                    <button onClick={() => setLogFilter('all')} className={`px-2 py-1 rounded ${logFilter === 'all' ? 'bg-white shadow text-indigo-600' : 'hover:bg-gray-300'}`}>全表示</button>
                                    <button onClick={() => setLogFilter('none')} className={`px-2 py-1 rounded ${logFilter === 'none' ? 'bg-white shadow text-indigo-600' : 'hover:bg-gray-300'}`}>隠す</button>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                                {getFilteredHistory().length === 0 && <div className="text-center text-gray-400 py-4 text-sm">{logFilter === 'none' ? 'ログは非表示です' : 'まだ記録がありません'}</div>}
                                {[...getFilteredHistory()].reverse().map((p, i) => (
                                    <div key={p.id} className="bg-white p-2 rounded border-l-4 border-indigo-500 text-sm shadow-sm">
                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                            <span>{p.inning}{p.isTop ? '表' : '裏'} vs {p.batter}</span>
                                            <span>{new Date(p.id).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                        </div>
                                        <div className="flex items-center font-bold">
                                            <span className="text-red-600 mr-2 min-w-[3rem]">{RESULTS.find(r => r.type === p.result)?.label || p.result}</span>
                                            {p.zoneLabel !== '-' && <span className="text-xs bg-gray-100 px-1 rounded mr-1">{p.zoneLabel}</span>}
                                            {p.location && <span className="text-xs bg-blue-100 px-1 rounded mr-1 text-blue-800">{p.location}</span>}
                                            {p.playResult && p.playResult !== p.result && <span className="text-xs text-gray-500 ml-auto text-right">{p.playResult}</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>

                            {/* Runner Modals (Processing / Manual) */}
                            {showProcessingModal && pendingPlay && (
                                <div className="absolute inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                                    <div className="bg-white rounded-lg shadow-xl p-4 w-full max-w-sm">
                                        <h3 className="font-bold text-lg mb-2 text-center bg-indigo-100 py-1 rounded text-indigo-800">打球結果処理 ({RESULTS.find(r=>r.type===pendingPlay.resultKey)?.label})</h3>
                                        <p className="text-xs text-gray-500 mb-4 text-center">各ランナーの進塁・結果を選択してください</p>
                                        <div className="space-y-3 mb-6">
                                            {[3, 2, 1].map(base => {
                                                if (!pendingPlay.runnerState[base]) return null;
                                                return (
                                                    <div key={base} className="flex items-center justify-between border-b pb-2">
                                                        <div className="font-bold w-16 text-center bg-gray-200 rounded py-1">{base}塁走者</div>
                                                        <select className="border rounded p-1 flex-1 ml-2 font-bold" value={runnerMovements[base] || 'stay'} onChange={(e) => handleMovementChange(base, e.target.value)}>
                                                            <option value="stay">{base}塁 (残留)</option>
                                                            {base < 2 && <option value="2B">2塁へ</option>}
                                                            {base < 3 && <option value="3B">3塁へ</option>}
                                                            <option value="home">本塁へ (生還)</option>
                                                            <option value="out">アウト</option>
                                                        </select>
                                                    </div>
                                                );
                                            })}
                                            <div className="text-xs text-right text-gray-400 mt-2">※打者走者は自動的に{pendingPlay.resultKey.includes('hit') ? (pendingPlay.resultKey==='hit1'?'1塁':pendingPlay.resultKey==='hit2'?'2塁':'3塁') : (pendingPlay.resultKey==='error'?'1塁':'アウト')}になります</div>
                                        </div>
                                        <button onClick={confirmProcessing} className="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold text-lg shadow hover:bg-indigo-700">確定</button>
                                        <button onClick={() => { setShowProcessingModal(false); setPendingPlay(null); }} className="w-full mt-2 py-2 text-gray-500 text-sm">キャンセル</button>
                                    </div>
                                </div>
                            )}
                            
                            {showRunnerModal && (
                                <div className="absolute inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4">
                                    <div className="bg-white rounded-lg shadow-xl p-4 w-full max-w-sm">
                                        <h3 className="font-bold text-lg mb-2 text-center text-gray-800">走塁・状況入力</h3>
                                        <p className="text-xs text-center text-gray-500 mb-4">赤色のランナーをタップして操作を選択</p>
                                        <div className="flex justify-center mb-6">
                                            <svg width="200" height="150" viewBox="0 0 200 150">
                                                <line x1="100" y1="130" x2="180" y2="75" stroke="#9ca3af" strokeWidth="2" />
                                                <line x1="180" y1="75" x2="100" y2="20" stroke="#9ca3af" strokeWidth="2" />
                                                <line x1="100" y1="20" x2="20" y2="75" stroke="#9ca3af" strokeWidth="2" />
                                                <line x1="20" y1="75" x2="100" y2="130" stroke="#9ca3af" strokeWidth="2" />
                                                {[2, 3, 1].map(b => (
                                                    <g key={b}>
                                                        <rect x={b===2?90:b===3?10:170} y={b===2?10:65} width="20" height="20" transform={`rotate(45 ${b===2?100:b===3?20:180} ${b===2?20:75})`} className={`runner-base ${gameState.runners[b] ? 'active' : 'empty'} ${selectedRunnerBase === b ? 'selected' : ''}`} onClick={() => gameState.runners[b] && setSelectedRunnerBase(b)} />
                                                        <text x={b===2?100:b===3?20:180} y={b===2?45:100} textAnchor="middle" fontSize="12" fill="#4b5563" fontWeight="bold">{b}塁</text>
                                                    </g>
                                                ))}
                                            </svg>
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded mb-4 h-32 flex flex-col justify-center">
                                            {!selectedRunnerBase ? <div className="text-center text-gray-400 text-sm">ランナーを選択してください</div> : (
                                                <div className="space-y-2">
                                                    <div className="text-center font-bold text-indigo-700 border-b pb-1 mb-2">{selectedRunnerBase}塁ランナーの操作</div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <button onClick={() => handleIndividualRunnerMove(selectedRunnerBase, 'advance')} className="bg-blue-600 text-white py-2 rounded text-sm font-bold hover:bg-blue-700">{selectedRunnerBase === 3 ? '本塁へ (得点)' : `${selectedRunnerBase + 1}塁へ盗塁/進塁`}</button>
                                                        <button onClick={() => handleIndividualRunnerMove(selectedRunnerBase, 'out')} className="bg-red-600 text-white py-2 rounded text-sm font-bold hover:bg-red-700">アウト (牽制/盗塁死)</button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={handleClearRunners} className="py-2 text-xs text-gray-500 underline">走者一掃(リセット)</button>
                                            <button onClick={() => setShowRunnerModal(false)} className="w-full py-2 bg-gray-600 text-white rounded font-bold hover:bg-gray-700">閉じる</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
